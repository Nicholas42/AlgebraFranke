%---- ENVIRONMENTS ----
%
\newenvironment{diagram*}[1][]{\begin{center}\begin{tikzpicture}[line join=round, line cap=round,#1]}{\end{tikzpicture}\end{center}}  


\NewDocumentEnvironment{diagram}{O{} O{}}{\diagramenv{#1}{#2}}{\enddiagramenv}
\NewEnviron{diagramenv}[2]{\begin{align}#2\begin{tikzpicture}[line cap=round, line join=round,#1]\BODY\end{tikzpicture}\end{align}}
%\NewDocumentEnvironment{diagram*}{O{} O{}}{\diagramenvv{#1}{#2}}{\enddiagramenvv}
%\NewEnviron{diagramenvv}[2]{\begin{align*}#2\begin{tikzpicture}[line cap=round, line join=round,#1]\BODY\end{tikzpicture}\end{align*}}

%---- MANY ALPHABETS ----
%
\renewcommand{\phi}{\varphi}
\renewcommand{\epsilon}{\varepsilon}

\newcommand{\Aa}{\mathcal{A}}
\newcommand{\Bb}{\mathcal{B}}
\newcommand{\Cc}{\mathcal{C}}
\newcommand{\Dd}{\mathcal{D}}
\newcommand{\Ee}{\mathcal{E}}
\newcommand{\Ff}{\mathcal{F}}
\newcommand{\Gg}{\mathcal{G}}
\newcommand{\Hh}{\mathcal{H}}
\newcommand{\Ii}{\mathcal{I}}
\newcommand{\Jj}{\mathcal{J}}
\newcommand{\Kk}{\mathcal{K}}
\newcommand{\Ll}{\mathcal{L}}
\newcommand{\Mm}{\mathcal{M}}
\newcommand{\Nn}{\mathcal{N}}
\newcommand{\Oo}{\mathcal{O}}
\newcommand{\Pp}{\mathcal{P}}
\newcommand{\Qq}{\mathcal{Q}}
\newcommand{\Rr}{\mathcal{R}}
\newcommand{\Ss}{\mathcal{S}}
\newcommand{\Tt}{\mathcal{T}}
\newcommand{\Uu}{\mathcal{U}}
\newcommand{\Vv}{\mathcal{V}}
\newcommand{\Ww}{\mathcal{W}}
\newcommand{\Xx}{\mathcal{X}}
\newcommand{\Yy}{\mathcal{Y}}
\newcommand{\Zz}{\mathcal{Z}}

\newcommand{\IA}{\mathbb{A}}
\newcommand{\IB}{\mathbb{B}}
\newcommand{\IC}{\mathbb{C}}
\newcommand{\ID}{\mathbb{D}}
\newcommand{\IE}{\mathbb{E}}
\newcommand{\IF}{\mathbb{F}}
\newcommand{\IG}{\mathbb{G}}
\newcommand{\IH}{\mathbb{H}}
%\newcommand{\II}{\mathbb{I}}
%\newcommand{\IJ}{\mathbb{J}}
\newcommand{\IK}{\mathbb{K}}
\newcommand{\IL}{\mathbb{L}}
\newcommand{\IM}{\mathbb{M}}
\newcommand{\IN}{\mathbb{N}}
\newcommand{\IO}{\mathbb{O}}
\newcommand{\IP}{\mathbb{P}}
\newcommand{\IQ}{\mathbb{Q}}
\newcommand{\IR}{\mathbb{R}}
\newcommand{\IS}{\mathbb{S}}
\newcommand{\IT}{\mathbb{T}}
\newcommand{\IU}{\mathbb{U}}
\newcommand{\IV}{\mathbb{V}}
\newcommand{\IW}{\mathbb{W}}
\newcommand{\IX}{\mathbb{X}}
\newcommand{\IY}{\mathbb{Y}}
\newcommand{\IZ}{\mathbb{Z}}

\renewcommand{\AA}{\mathfrak{A}}
\newcommand{\BB}{\mathfrak{B}}
\newcommand{\CC}{\mathfrak{C}}
\newcommand{\DD}{\mathfrak{D}}
\newcommand{\EE}{\mathfrak{E}}
\newcommand{\FF}{\mathfrak{F}}
\newcommand{\GG}{\mathfrak{G}}
\newcommand{\HH}{\mathfrak{H}}
\newcommand{\II}{\mathfrak{I}}
\newcommand{\JJ}{\mathfrak{J}}
\newcommand{\KK}{\mathfrak{K}}
\newcommand{\LL}{\mathfrak{L}}
\newcommand{\MM}{\mathfrak{M}}
\newcommand{\NN}{\mathfrak{N}}
\newcommand{\OO}{\mathfrak{O}}
\newcommand{\PP}{\mathfrak{P}}
\newcommand{\QQ}{\mathfrak{Q}}
\newcommand{\RR}{\mathfrak{R}}
\renewcommand{\SS}{\mathfrak{S}}
\newcommand{\TT}{\mathfrak{T}}
\newcommand{\UU}{\mathfrak{U}}
\newcommand{\VV}{\mathfrak{V}}
\newcommand{\WW}{\mathfrak{W}}
\newcommand{\XX}{\mathfrak{X}}
\newcommand{\YY}{\mathfrak{Y}}
\newcommand{\ZZ}{\mathfrak{Z}}

\renewcommand{\aa}{\mathfrak{a}}
\newcommand{\bb}{\mathfrak{b}}
\newcommand{\cc}{\mathfrak{c}}
\newcommand{\dd}{\mathfrak{d}}
\newcommand{\ee}{\mathfrak{e}}
\newcommand{\ff}{\mathfrak{f}}
\let\gge\gg
\renewcommand{\gg}{\mathfrak{g}}
\newcommand{\hh}{\mathfrak{h}}
\newcommand{\ii}{\mathfrak{i}}
\newcommand{\jj}{\mathfrak{j}}
\newcommand{\kk}{\mathfrak{k}}
\let\lle\ll
\renewcommand{\ll}{\mathfrak{l}}
\newcommand{\mm}{\mathfrak{m}}
\newcommand{\nn}{\mathfrak{n}}
\newcommand{\oo}{\mathfrak{o}}
\newcommand{\pp}{\mathfrak{p}}
\newcommand{\qq}{\mathfrak{q}}
\newcommand{\rr}{\mathfrak{r}}
%\newcommand{\ss}{\mathfrak{s}}
%\newcommand{\tt}{\mathfrak{t}}
\newcommand{\uu}{\mathfrak{u}}
\newcommand{\vv}{\mathfrak{v}}
\newcommand{\ww}{\mathfrak{w}}
\newcommand{\xx}{\mathfrak{x}}
\newcommand{\yy}{\mathfrak{y}}
\newcommand{\zz}{\mathfrak{z}}

%---- OPERATORS
%
\newcommand{\newoperator}[1]{\expandafter\def\csname #1\endcsname{\operatorname{#1}}}

\newcommand{\Ann}{\operatorname{Ann}}
\newcommand{\Aut}{\operatorname{Aut}}
\newcommand{\cha}{\operatorname{char}}
\newcommand{\codim}{\operatorname{codim}}
\newcommand{\End}{\operatorname{End}}
\newcommand{\Gal}{\operatorname{Gal}}
\newcommand{\Hom}{\operatorname{Hom}}
\newcommand{\hoehe}{\operatorname{ht}}
\newcommand{\id}{\operatorname{id}}
\newoperator{lcm}
\renewcommand{\Im}{\operatorname{Im}}
\newcommand{\mSpec}{\mm\operatorname{-Spec}}
\newoperator{Ob}
\newoperator{GL}
\newoperator{Min}
\newoperator{Sheaf}
\newcommand{\sh}{\mathrm{sh}}
\newcommand{\red}{\mathrm{red}}
\newoperator {Cl}
\newoperator{Pic}
\renewcommand{\det}{\operatorname{det}}%otherwise, det_K behaves strangely in displaymode
\newoperator{Mat}
\newoperator{Tr}
\newcommand{\norm}{\operatorname{N}}
\newcommand{\op}{\mathrm{op}}
\newoperator{sep}
\newoperator{rad}
\newoperator{Cov}
\newoperator{Con}
\newoperator{Der}
\newoperator{Funct}
\newoperator{Coeq}
\newoperator{Eq}
\newoperator{Bil}
\newoperator{coker}
\newcommand{\proj}{\mathrm{proj}}
\newcommand{\aff}{\mathrm{aff}}
\newcommand{\nil}{\operatorname{nil}}
\newcommand{\Spec}{\operatorname{Spec}}
\newcommand{\tr}{\operatorname{tr}}
\newcommand{\cat}[1]{\operatorname{#1}}%style of categories
%inductive limit
\newcommand\colimit[1][]{
	\mathchoice{\underset{\substack{\displaystyle{\longrightarrow}\\#1}}{\lim}}%displaystyle
	{\underset{\textstyle\longrightarrow}{\lim}\underset{#1}{}}%textstyle
	{\underset{\scriptstyle\longrightarrow}{\lim}\underset{#1}{}}
	{\underset{\longrightarrow}{\lim}\underset{#1}{}}\ %
}
%projective limit
\newcommand\limit[1][]{
	\mathchoice{\underset{\substack{\displaystyle{\longleftarrow}\\#1}}{\lim}}%displaystyle
	{\underset{\textstyle\longleftarrow}{\lim}\underset{#1}{}}%textstyle
	{\underset{\scriptstyle\longleftarrow}{\lim}\underset{#1}{}}
	{\underset{\longleftarrow}{\lim}\underset{#1}{}}\ %
}

%---- FANCY ARROWS ----
%
\newcommand{\longto}{\longrightarrow}
\newcommand{\longot}{\longleftarrow}
\newcommand{\isomorphism}[1][]{
	\mathrel{\tikz[baseline=(a.base)] \node (a) at (0,0) {$\!\!\longrightarrow\!\!$} node[above=-0.25ex] {\tiny $\sim$} node[below=-0.25ex] {$\scriptstyle #1$};}}
\newcommand{\lisomorphism}[1][]{
	\mathrel{\tikz[baseline=(a.base)] \node (a) at (0,0) {$\!\!\longleftarrow\!\!$} node[above=-0.25ex] {\tiny $\sim$} node[below=-0.25ex] {$\scriptstyle #1$};}}
\NewDocumentCommand{\doublemorphism}{O{} O{}}{\mathrel{\overset{#1}{\underset{#2}{\substack{\textstyle\longrightarrow\\[-0.67ex]
			\textstyle\longrightarrow}}}}}
\NewDocumentCommand{\doublelmorphism}{O{} O{}}{\mathrel{\overset{#1}{\underset{#2}{\substack{\textstyle\longleftarrow\\[-0.67ex]
					\textstyle\longleftarrow}}}}}
\NewDocumentCommand{\doublelrmorphism}{O{} O{}}{\mathrel{\overset{#1}{\underset{#2}{\substack{\textstyle\longrightarrow\\[-0.67ex]
					\textstyle\longleftarrow}}}}}
\NewDocumentCommand{\xdoublemorphism}{O{} O{}}{\mathrel{\substack{\textstyle\xrightarrow[\hphantom{#2}]{#1}\\[-2.45ex]
					\textstyle\xrightarrow[#2]{\hphantom{#1}}}}}
\NewDocumentCommand{\xdoublelmorphism}{O{} O{}}{\mathrel{\substack{\textstyle\xleftarrow{#1}\\[-0.67ex]
			\textstyle\xleftarrow[#2]{}}}}
\NewDocumentCommand{\xdoublelrmorphism}{O{} O{}}{\mathrel{\substack{\textstyle\xleftrightarrow{#1}\\[-0.67ex]
			\textstyle\xleftrightarrow[#2]{}}}}

\newcommand{\IsArgEmpty}[3]{%
	\if\relax\detokenize{#1}\relax%
		#2%
	\else%
		#3%
	\fi}

\DeclareRobustCommand\longtwoheadrightarrow
{\relbar\joinrel\twoheadrightarrow}
\DeclareRobustCommand\longtwoheadleftarrow
{\twoheadleftarrow\joinrel\relbar}

\newcommand{\morphism}[1][]{%
	\mathchoice{\overset{#1}{\longto}}%
	{\IsArgEmpty{#1}{\rightarrow}{\overset{#1}{\longrightarrow}}}%
	{\IsArgEmpty{#1}{\rightarrow}{\overset{#1}{\longrightarrow}}}%
	{\IsArgEmpty{#1}{\rightarrow}{\overset{#1}{\longrightarrow}}}%
}
\newcommand{\lmorphism}[1][]{%
	\mathchoice{\overset{#1}{\longot}}%
	{\IsArgEmpty{#1}{\leftarrow}{\overset{#1}{\longleftarrow}}}%
	{\IsArgEmpty{#1}{\leftarrow}{\overset{#1}{\longleftarrow}}}%
	{\IsArgEmpty{#1}{\leftarrow}{\overset{#1}{\longleftarrow}}}%
}
\newcommand{\lrmorphism}[1][]{%
	\mathchoice{\overset{#1}{\longleftrightarrow}}%
	{\IsArgEmpty{#1}{\leftrightarrow}{\overset{#1}{\longleftrightarrow}}}%
	{\IsArgEmpty{#1}{\leftrightarrow}{\overset{#1}{\longleftrightarrow}}}%
	{\IsArgEmpty{#1}{\leftrightarrow}{\overset{#1}{\longleftrightarrow}}}%
}
\newcommand{\monomorphism}[1][]{%
	\mathchoice{\overset{#1}{\mathrel{\smash{\longhookrightarrow}\vphantom{\rightarrow}}}}%
	{\IsArgEmpty{#1}{\hookrightarrow}{\overset{#1}{\mathrel{\smash{\longhookrightarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\hookrightarrow}{\overset{#1}{\mathrel{\smash{\longhookrightarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\hookrightarrow}{\overset{#1}{\mathrel{\smash{\longhookrightarrow}\vphantom{\rightarrow}}}}}%
}
\newcommand{\lmonomorphism}[1][]{%
	\mathchoice{\overset{#1}{\mathrel{\smash{\longhookleftarrow}\vphantom{\rightarrow}}}}%
	{\IsArgEmpty{#1}{\hookleftarrow}{\overset{#1}{\mathrel{\smash{\longhookleftarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\hookleftarrow}{\overset{#1}{\mathrel{\smash{\longhookleftarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\hookleftarrow}{\overset{#1}{\mathrel{\smash{\longhookleftarrow}\vphantom{\rightarrow}}}}}%
}
\newcommand{\epimorphism}[1][]{%
	\mathchoice{\overset{#1}{\mathrel{\smash{\longtwoheadrightarrow}\vphantom{\rightarrow}}}}%
	{\IsArgEmpty{#1}{\twoheadrightarrow}{\overset{#1}{\mathrel{\smash{\longtwoheadrightarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\twoheadrightarrow}{\overset{#1}{\mathrel{\smash{\longtwoheadrightarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\twoheadrightarrow}{\overset{#1}{\mathrel{\smash{\longtwoheadrightarrow}\vphantom{\rightarrow}}}}}%
}
\newcommand{\lepimorphism}[1][]{%
	\mathchoice{\overset{#1}{\mathrel{\smash{\longtwoheadleftarrow}\vphantom{\rightarrow}}}}%
	{\IsArgEmpty{#1}{\twoheadleftarrow}{\overset{#1}{\mathrel{\smash{\longtwoheadleftarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\twoheadleftarrow}{\overset{#1}{\mathrel{\smash{\longtwoheadleftarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\twoheadleftarrow}{\overset{#1}{\mathrel{\smash{\longtwoheadleftarrow}\vphantom{\rightarrow}}}}}%
}

%---- MODIFIERS ----
%
\newcommand{\ov}{\overline}
\newcommand{\snake}[1]{\widetilde{#1}\vphantom{\overrightarrow{#1}}}%space adjusting hack



%---- MISCELLANEOUS ----
%
\newcommand{\defemph}[1]{\textbf{\upshape#1}} %emphasize style of a to-be-defined object in a definition
\newcommand{\itememph}[1]{$(#1)$} %style of alphabetically ordered items
\newcommand{\NAK}{\hyperref[prop:NAK]{[NAK]}}
\newcommand{\ldotspam}{,\ldots,}
\newcommand{\ordinalst}{^{\text{st}}}
\newcommand{\ordinalrd}{^{\text{rd}}}
\newcommand{\ordinalth}{^{\text{th}}}
\newcommand{\st}{\ \middle|\ }
%\newcommand{\dashed}{dash pattern = on 2pt off 2pt}

\def\clap#1{\hbox to 0pt{\hss#1\hss}}
\def\mathllap{\mathpalette\mathllapinternal}
\def\mathrlap{\mathpalette\mathrlapinternal}
\def\mathclap{\mathpalette\mathclapinternal}
\def\mathllapinternal#1#2{%
	\llap{$\mathsurround=0pt#1{#2}$}}
\def\mathrlapinternal#1#2{%
	\rlap{$\mathsurround=0pt#1{#2}$}}
\def\mathclapinternal#1#2{%
	\clap{$\mathsurround=0pt#1{#2}$}}

%nice sqrt
\LetLtxMacro{\oldsqrt}{\sqrt} 
\renewcommand{\sqrt}[1][\ ]{%
	\def\DHLindex{#1}\mathpalette\DHLhksqrt}
\def\DHLhksqrt#1#2{%
	\setbox0=\hbox{$#1\oldsqrt[\DHLindex]{#2\,}$}\dimen0=\ht0
	\advance\dimen0-0.2\ht0
	\setbox2=\hbox{\vrule height\ht0 depth -\dimen0}%
	{\box0\lower0.71pt\box2}}


