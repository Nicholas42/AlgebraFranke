%---- ENVIRONMENTS ----
%
\NewDocumentEnvironment{diagram*}{O{} O{}}{\diagramenvv{#1}{#2}}{\enddiagramenvv}
\NewEnviron{diagramenvv}[2]{\begin{align*}#2\begin{tikzpicture}[line cap=round, line join=round,#1]\BODY\end{tikzpicture}\end{align*}}

\NewDocumentEnvironment{diagram}{O{} O{}}{\diagramenv{#1}{#2}}{\enddiagramenv}
\NewEnviron{diagramenv}[2]{\begin{align}#2\begin{tikzpicture}[line cap=round, line join=round,#1]\BODY\end{tikzpicture}\end{align}}

\NewDocumentCommand\object{O{ob} m m O{}}{\node[#1] (#4) at (#2) {#3}}
\NewDocumentCommand\arrow{O{->} m m O{} O{}}{\draw[#1] (#2) to node[pos=0.5,#4] {#5} (#3)}
\NewDocumentCommand\isoarrow{O{->} m m O{} O{}}{\draw[#1] (#2) to node[pos=0.5, above=-0.25ex, sloped] {$\sim$} node[pos=0.5,#4] {#5} (#3)}
\newcommand{\pushout}[1]{\draw (#1) ++ (-0.75ex,-0.75ex) -- ++(0ex,1.5ex) -- ++ (1.5ex,0ex);\fill (#1) ++ (0.5ex,-0.5ex) circle (0.5pt)}
\newcommand{\pullback}[1]{\draw (#1) ++ (-0.75ex,-0.75ex) -- ++(1.5ex,0ex) -- ++ (0ex,1.5ex);\fill (#1) ++ (-0.5ex,0.5ex) circle (0.5pt)}

\newlength{\arrowlength}
\settowidth{\arrowlength}{$\longrightarrow$}

%---- MANY ALPHABETS ----
%
\renewcommand{\phi}{\varphi}
\renewcommand{\epsilon}{\varepsilon}

\newcommand{\Aa}{\mathcal{A}}
\newcommand{\Bb}{\mathcal{B}}
\newcommand{\Cc}{\mathcal{C}}
\newcommand{\Dd}{\mathcal{D}}
\newcommand{\Ee}{\mathcal{E}}
\newcommand{\Ff}{\mathcal{F}}
\newcommand{\Gg}{\mathcal{G}}
\newcommand{\Hh}{\mathcal{H}}
\newcommand{\Ii}{\mathcal{I}}
\newcommand{\Jj}{\mathcal{J}}
\newcommand{\Kk}{\mathcal{K}}
\newcommand{\Ll}{\mathcal{L}}
\newcommand{\Mm}{\mathcal{M}}
\newcommand{\Nn}{\mathcal{N}}
\newcommand{\Oo}{\mathcal{O}}
\newcommand{\Pp}{\mathcal{P}}
\newcommand{\Qq}{\mathcal{Q}}
\newcommand{\Rr}{\mathcal{R}}
\newcommand{\Ss}{\mathcal{S}}
\newcommand{\Tt}{\mathcal{T}}
\newcommand{\Uu}{\mathcal{U}}
\newcommand{\Vv}{\mathcal{V}}
\newcommand{\Ww}{\mathcal{W}}
\newcommand{\Xx}{\mathcal{X}}
\newcommand{\Yy}{\mathcal{Y}}
\newcommand{\Zz}{\mathcal{Z}}

\newcommand{\IA}{\mathbb{A}}
\newcommand{\IB}{\mathbb{B}}
\newcommand{\IC}{\mathbb{C}}
\newcommand{\ID}{\mathbb{D}}
\newcommand{\IE}{\mathbb{E}}
\newcommand{\IF}{\mathbb{F}}
\newcommand{\IG}{\mathbb{G}}
\newcommand{\IH}{\mathbb{H}}
%\newcommand{\II}{\mathbb{I}}
%\newcommand{\IJ}{\mathbb{J}}
\newcommand{\IK}{\mathbb{K}}
\newcommand{\IL}{\mathbb{L}}
\newcommand{\IM}{\mathbb{M}}
\newcommand{\IN}{\mathbb{N}}
\newcommand{\IO}{\mathbb{O}}
\newcommand{\IP}{\mathbb{P}}
\newcommand{\IQ}{\mathbb{Q}}
\newcommand{\IR}{\mathbb{R}}
\newcommand{\IS}{\mathbb{S}}
\newcommand{\IT}{\mathbb{T}}
\newcommand{\IU}{\mathbb{U}}
\newcommand{\IV}{\mathbb{V}}
\newcommand{\IW}{\mathbb{W}}
\newcommand{\IX}{\mathbb{X}}
\newcommand{\IY}{\mathbb{Y}}
\newcommand{\IZ}{\mathbb{Z}}

\renewcommand{\AA}{\mathfrak{A}}
\newcommand{\BB}{\mathfrak{B}}
\newcommand{\CC}{\mathfrak{C}}
\newcommand{\DD}{\mathfrak{D}}
\newcommand{\EE}{\mathfrak{E}}
\newcommand{\FF}{\mathfrak{F}}
\newcommand{\GG}{\mathfrak{G}}
\newcommand{\HH}{\mathfrak{H}}
\newcommand{\II}{\mathfrak{I}}
\newcommand{\JJ}{\mathfrak{J}}
\newcommand{\KK}{\mathfrak{K}}
\newcommand{\LL}{\mathfrak{L}}
\newcommand{\MM}{\mathfrak{M}}
\newcommand{\NN}{\mathfrak{N}}
\newcommand{\OO}{\mathfrak{O}}
\newcommand{\PP}{\mathfrak{P}}
\newcommand{\QQ}{\mathfrak{Q}}
\newcommand{\RR}{\mathfrak{R}}
\renewcommand{\SS}{\mathfrak{S}}
\newcommand{\TT}{\mathfrak{T}}
\newcommand{\UU}{\mathfrak{U}}
\newcommand{\VV}{\mathfrak{V}}
\newcommand{\WW}{\mathfrak{W}}
\newcommand{\XX}{\mathfrak{X}}
\newcommand{\YY}{\mathfrak{Y}}
\newcommand{\ZZ}{\mathfrak{Z}}

\renewcommand{\aa}{\mathfrak{a}}
\newcommand{\bb}{\mathfrak{b}}
\newcommand{\cc}{\mathfrak{c}}
\newcommand{\dd}{\mathfrak{d}}
\newcommand{\ee}{\mathfrak{e}}
\newcommand{\ff}{\mathfrak{f}}
\let\gge\gg
\renewcommand{\gg}{\mathfrak{g}}
\newcommand{\hh}{\mathfrak{h}}
\newcommand{\ii}{\mathfrak{i}}
\newcommand{\jj}{\mathfrak{j}}
\newcommand{\kk}{\mathfrak{k}}
\let\lle\ll
\renewcommand{\ll}{\mathfrak{l}}
\newcommand{\mm}{\mathfrak{m}}
\newcommand{\nn}{\mathfrak{n}}
\newcommand{\oo}{\mathfrak{o}}
\newcommand{\pp}{\mathfrak{p}}
\newcommand{\qq}{\mathfrak{q}}
\newcommand{\rr}{\mathfrak{r}}
%\newcommand{\ss}{\mathfrak{s}}
%\newcommand{\tt}{\mathfrak{t}}
\newcommand{\uu}{\mathfrak{u}}
\newcommand{\vv}{\mathfrak{v}}
\newcommand{\ww}{\mathfrak{w}}
\newcommand{\xx}{\mathfrak{x}}
\newcommand{\yy}{\mathfrak{y}}
\newcommand{\zz}{\mathfrak{z}}

%---- OPERATORS
%
\newcommand{\newoperator}[1]{\expandafter\def\csname #1\endcsname{\operatorname{#1}}}

\newcommand{\Ann}{\operatorname{Ann}}
\newcommand{\Aann}{\operatorname{\Aa nn}}
\newoperator{Ass}
\newcommand{\Aut}{\operatorname{Aut}}
\newcommand{\cha}{\operatorname{char}}
\newcommand{\codim}{\operatorname{codim}}
\newcommand{\End}{\operatorname{End}}
\newcommand{\Gal}{\operatorname{Gal}}
\newcommand{\Hom}{\operatorname{Hom}}
\newcommand{\Hhom}{\operatorname{\Hh om}}
\newcommand{\hoehe}{\operatorname{ht}}
\newcommand{\id}{\operatorname{id}}
\newoperator{lcm}
\renewcommand{\Im}{\operatorname{Im}}
\newoperator{Coim}
\newcommand{\mSpec}{\mm\operatorname{-Spec}}
\newoperator{Ob}
\newoperator{GL}
\newoperator{SL}
\newoperator{Min}
\newoperator{Sheaf}
\newcommand{\sh}{\mathrm{sh}}
\newcommand{\red}{\mathrm{red}}
\newcommand{\alt}{\mathrm{alt}}
\newoperator {Cl}
\newoperator{Pic}
\newcommand{\PIC}{\mathbf{Pic}}
\newoperator{Sym}
\newoperator{Div}
\renewcommand{\det}{\operatorname{det}}%otherwise, det_K behaves strangely in displaymode
\newoperator{Mat}
\newoperator{Tr}
\newcommand{\norm}{\operatorname{N}}
\newcommand{\op}{\mathrm{op}}
\newoperator{sep}
\newoperator{rad}
\newoperator{Cov}
\newoperator{Con}
\newoperator{Der}
\newoperator{Funct}
\newoperator{Coeq}
\newoperator{Eq}
\newoperator{Bil}
\newoperator{Cone}
\newoperator{coker}
\newoperator{supp}
\newoperator{length}
\newoperator{depth}
\newoperator{rank}
\newcommand{\trdeg}{\operatorname{tr.deg}}
\newcommand{\idim}{\operatorname{inj.dim}}
\newcommand{\pdim}{\operatorname{pr.dim}}
\newcommand{\gdim}{\operatorname{gl.dim}}
\newcommand{\fdim}{\operatorname{fl.dim}}
\newoperator{gr}
\renewcommand{\div}{\operatorname{div}}
\newoperator{Tor}
\newoperator{Tot}
\newoperator{Ext}
\newoperator{sgn}
\DeclareMathOperator{\SPEC}{\mathbf{Spec}}
\DeclareMathOperator{\PROJ}{\mathbf{Proj}}
\newcommand{\proj}{\mathrm{proj}}
\newcommand{\aff}{\mathrm{aff}}
\newcommand{\nil}{\operatorname{nil}}
\newcommand{\Spec}{\operatorname{Spec}}
\newoperator{Proj}
\newoperator{res}
\newcommand{\hor}{\mathrm{hor}}
\newcommand{\ver}{\mathrm{vert}}
\newcommand{\tr}{\operatorname{tr}}
\newcommand{\cat}[1]{\StrLen{#1}[\temp]%\temp
	\ifnum\temp=1%
	\boldsymbol{#1}%
	\else%
	\mathbf{#1}%
	\fi%
}%style of categories
%inductive limit
\NewDocumentCommand\colimit{O{} O{}}{
	\mathchoice{\underset{\substack{\displaystyle{\longrightarrow}\\[-1pt]#1}}{\lim}#2}%displaystyle
	{\underset{\textstyle\longrightarrow}{\lim}#2_{#1}}%textstyle
	{\underset{\scriptstyle\longrightarrow}{\lim}#2_{#1}}
	{\underset{\longrightarrow}{\lim}#2_{#1}}\ %
}
%projective limit
\NewDocumentCommand\limit{O{} O{}}{
	\mathchoice{\underset{\substack{\displaystyle{\longleftarrow}\\[-1pt]#1}}{\lim}#2}%displaystyle
	{\underset{\textstyle\longleftarrow}{\lim}#2_{#1}}%textstyle
	{\underset{\scriptstyle\longleftarrow}{\lim}#2_{#1}}
	{\underset{\longleftarrow}{\lim}#2_{#1}}\ %
}

%---- FANCY ARROWS ----
%
\newcommand{\longto}{\longrightarrow}
\newcommand{\longot}{\longleftarrow}
\newcommand{\isomorphism}[1][]{
	\mathrel{\tikz[baseline=(a.base)] \node (a) at (0,0) {$\!\!\longrightarrow\!\!$} node[above=-0.25ex] {\smash{\tiny $\sim$}} node[below=-0.25ex] {$\scriptstyle #1$};}}
\newcommand{\lisomorphism}[1][]{
	\mathrel{\tikz[baseline=(a.base)] \node (a) at (0,0) {$\!\!\longleftarrow\!\!$} node[above=-0.25ex] {\tiny $\sim$} node[below=-0.25ex] {$\scriptstyle #1$};}}
\NewDocumentCommand{\doublemorphism}{O{} O{}}{\mathrel{\overset{#1}{\underset{#2}{\substack{\textstyle\longrightarrow\\[-0.67ex]
			\textstyle\longrightarrow}}}}}
\NewDocumentCommand{\doublelmorphism}{O{} O{}}{\mathrel{\overset{#1}{\underset{#2}{\substack{\textstyle\longleftarrow\\[-0.67ex]
					\textstyle\longleftarrow}}}}}
\NewDocumentCommand{\doublelrmorphism}{O{} O{}}{\mathrel{\overset{#1}{\underset{#2}{\substack{\textstyle\longrightarrow\\[-0.67ex]
					\textstyle\longleftarrow}}}}}
\NewDocumentCommand{\xdoublemorphism}{O{} O{}}{\mathrel{\substack{\textstyle\xrightarrow[\hphantom{#2}]{#1}\\[-2.45ex]
					\textstyle\xrightarrow[#2]{\hphantom{#1}}}}}
\NewDocumentCommand{\xdoublelmorphism}{O{} O{}}{\mathrel{\substack{\textstyle\xleftarrow{#1}\\[-0.67ex]
			\textstyle\xleftarrow[#2]{}}}}
\NewDocumentCommand{\xdoublelrmorphism}{O{} O{}}{\mathrel{\substack{\textstyle\xleftrightarrow{#1}\\[-0.67ex]
			\textstyle\xleftrightarrow[#2]{}}}}

\newcommand{\IsArgEmpty}[3]{%
	\if\relax\detokenize{#1}\relax%
		#2%
	\else%
		#3%
	\fi}

\DeclareRobustCommand\longtwoheadrightarrow
{\relbar\joinrel\twoheadrightarrow}
\DeclareRobustCommand\longtwoheadleftarrow
{\twoheadleftarrow\joinrel\relbar}

\newcommand{\morphism}[1][]{%
	\mathchoice{\overset{#1}{\longto}}%
	{\IsArgEmpty{#1}{\rightarrow}{\overset{#1}{\longrightarrow}}}%
	{\IsArgEmpty{#1}{\rightarrow}{\overset{#1}{\longrightarrow}}}%
	{\IsArgEmpty{#1}{\rightarrow}{\overset{#1}{\longrightarrow}}}%
}
\newcommand{\lmorphism}[1][]{%
	\mathchoice{\overset{#1}{\longot}}%
	{\IsArgEmpty{#1}{\leftarrow}{\overset{#1}{\longleftarrow}}}%
	{\IsArgEmpty{#1}{\leftarrow}{\overset{#1}{\longleftarrow}}}%
	{\IsArgEmpty{#1}{\leftarrow}{\overset{#1}{\longleftarrow}}}%
}
\newcommand{\lrmorphism}[1][]{%
	\mathchoice{\overset{#1}{\longleftrightarrow}}%
	{\IsArgEmpty{#1}{\leftrightarrow}{\overset{#1}{\longleftrightarrow}}}%
	{\IsArgEmpty{#1}{\leftrightarrow}{\overset{#1}{\longleftrightarrow}}}%
	{\IsArgEmpty{#1}{\leftrightarrow}{\overset{#1}{\longleftrightarrow}}}%
}
\newcommand{\monomorphism}[1][]{%
	\mathchoice{\overset{#1}{\mathrel{\smash{\longhookrightarrow}\vphantom{\rightarrow}}}}%
	{\IsArgEmpty{#1}{\hookrightarrow}{\overset{#1}{\mathrel{\smash{\longhookrightarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\hookrightarrow}{\overset{#1}{\mathrel{\smash{\longhookrightarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\hookrightarrow}{\overset{#1}{\mathrel{\smash{\longhookrightarrow}\vphantom{\rightarrow}}}}}%
}
\newcommand{\lmonomorphism}[1][]{%
	\mathchoice{\overset{#1}{\mathrel{\smash{\longhookleftarrow}\vphantom{\rightarrow}}}}%
	{\IsArgEmpty{#1}{\hookleftarrow}{\overset{#1}{\mathrel{\smash{\longhookleftarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\hookleftarrow}{\overset{#1}{\mathrel{\smash{\longhookleftarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\hookleftarrow}{\overset{#1}{\mathrel{\smash{\longhookleftarrow}\vphantom{\rightarrow}}}}}%
}
\newcommand{\epimorphism}[1][]{%
	\mathchoice{\overset{#1}{\mathrel{\smash{\longtwoheadrightarrow}\vphantom{\rightarrow}}}}%
	{\IsArgEmpty{#1}{\twoheadrightarrow}{\overset{#1}{\mathrel{\smash{\longtwoheadrightarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\twoheadrightarrow}{\overset{#1}{\mathrel{\smash{\longtwoheadrightarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\twoheadrightarrow}{\overset{#1}{\mathrel{\smash{\longtwoheadrightarrow}\vphantom{\rightarrow}}}}}%
}
\newcommand{\lepimorphism}[1][]{%
	\mathchoice{\overset{#1}{\mathrel{\smash{\longtwoheadleftarrow}\vphantom{\rightarrow}}}}%
	{\IsArgEmpty{#1}{\twoheadleftarrow}{\overset{#1}{\mathrel{\smash{\longtwoheadleftarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\twoheadleftarrow}{\overset{#1}{\mathrel{\smash{\longtwoheadleftarrow}\vphantom{\rightarrow}}}}}%
	{\IsArgEmpty{#1}{\twoheadleftarrow}{\overset{#1}{\mathrel{\smash{\longtwoheadleftarrow}\vphantom{\rightarrow}}}}}%
}

\newcommand{\converge}{%
	\mathchoice{\Longrightarrow}%
	{\Rightarrow}%
	{\Rightarrow}%
	{\Rightarrow}%
}

\newcommand{\lconverge}{%
	\mathchoice{\Longleftarrow}%
	{\Leftarrow}%
	{\Leftarrow}%
	{\Leftarrow}%
}

%---- MODIFIERS ----
%
\newcommand{\ov}{\overline}

\newcommand{\hacek}[1]{\check{#1}\hspace{0.06125em}}

\DeclareMathSymbol{\widehatsym}{\mathord}{largesymbols}{"62}
\newcommand\lowerwidehatsym{%
	\text{\smash{\raisebox{-1.3ex}{%
				$\widehatsym$}}}}
\newcommand\fixwidehat[1]{\accentset{\displaystyle\lowerwidehatsym}{#1}}%
	%\mathchoice
	%{\accentset{\displaystyle\lowerwidehatsym}{#1}}
	%{\accentset{\textstyle\lowerwidehatsym}{#1}}
	%{\accentset{\scriptstyle\lowerwidehatsym}{#1}}
	%{\accentset{\scriptscriptstyle\lowerwidehatsym}{#1}}
%}
\DeclareMathSymbol{\widetildesym}{\mathord}{largesymbols}{"65}
\newcommand\lowerwidetildesym{%
	\text{\smash{\raisebox{-1.3ex}{%
				$\widetildesym$}}}}
\newcommand\fixwidetilde[1]{\accentset{\displaystyle\lowerwidetildesym}{#1}}%
	%\mathchoice
	%{\accentset{\displaystyle\lowerwidetildesym}{#1}}
	%{\accentset{\textstyle\lowerwidetildesym}{#1}}
%	{\accentset{\scriptstyle\lowerwidetildesym}{#1}}
	%{\accentset{\scriptscriptstyle\lowerwidetildesym}{#1}}
%}
\newcommand{\snake}[1]{\fixwidetilde{#1}}%space adjusting hack
\newcommand{\roof}[1]{\fixwidehat{#1}}
\newcommand{\complete}{\lowerwidehatsym}
\newcommand{\qcmod}{\lowerwidetildesym}
%---- MISCELLANEOUS ----
%
\newcommand{\defemph}[1]{\textbf{\upshape#1}} %emphasize style of a to-be-defined object in a definition
\newcommand{\itememph}[1]{$(#1)$} %style of alphabetically ordered items
\newcommand{\NAK}{\hyperref[prop:NAK]{[NAK]}}
\newcommand{\ldotspam}{,\ldots,}
\newcommand{\ordinalst}{^{\text{st}}}
\newcommand{\ordinalnd}{^{\text{nd}}}
\newcommand{\ordinalrd}{^{\text{rd}}}
\newcommand{\ordinalth}{^{\text{th}}}
\newcommand{\st}{\ \middle|\ }
%\newcommand{\dashed}{dash pattern = on 2pt off 2pt}

%fibre products
\newcommand{\fprod}[1]{\sideset{}{_{#1}}\prod}